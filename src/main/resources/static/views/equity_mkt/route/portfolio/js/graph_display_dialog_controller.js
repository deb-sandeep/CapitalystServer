capitalystNgApp.controller( 'GraphDisplayDialogController', function( $scope ) {
    
    const BUY_COLOR            = '#256BEF' ;
    const SELL_COLOR           = '#E7871C' ;
    const EOD_LINE_COLOR       = '#CECFD3' ;
    const AVG_LINE_COLOR       = '#80CC77' ;
    const SCATTER_POINT_RADIUS = 4 ;
    
    // ---------------- Local variables --------------------------------------
    var chart = null ;
    
    // ---------------- Scope variables --------------------------------------
    $scope.holding = null ;
    $scope.eodData = [] ;
    
    // -----------------------------------------------------------------------
    // --- [START] Scope functions -------------------------------------------
    
    $scope.$on( 'graphDialogDisplayTrigger', function( _event, args ) {
        $scope.holding = args.holding ;
        console.log( "Trigger obtained. " ) ;
        console.log( $scope.holding ) ;
        drawChart() ;
    } ) ;
    
    $scope.hideGraphDialog = function( holding ) {
        if( chart != null ) {
            chart.destroy() ;
        }
        $( '#graphDisplayDialog' ).modal( 'hide' ) ;
    }
    
    // --- [END] Scope functions

    // -----------------------------------------------------------------------
    // --- [START] Local functions -------------------------------------------
    
    // ------------------- Server comm functions -----------------------------
    function drawChart() {
        
        const ctx = document.getElementById( 'eodGraph' ) ;
        
        var labels = [
          1622485800000, 1622572200000, 1622658600000, 1622745000000, 1622831400000, 1622917800000, 
          1623004200000, 1623090600000, 1623177000000, 1623263400000, 1623349800000, 1623436200000, 
          1623522600000, 1623609000000, 1623695400000, 1623781800000, 1623868200000, 1623954600000, 
          1624041000000, 1624127400000, 1624213800000, 1624300200000, 1624386600000, 1624473000000, 
          1624559400000, 1624645800000, 1624732200000, 1624818600000, 1624905000000, 1624991400000, 
          1625077800000, 1625164200000, 1625250600000, 1625337000000, 1625423400000, 1625509800000, 
          1625596200000, 1625682600000, 1625769000000, 1625855400000, 1625941800000, 1626028200000, 
          1626114600000, 1626201000000, 1626287400000, 1626373800000, 1626460200000, 1626546600000, 
          1626633000000, 1626719400000, 1626805800000, 1626892200000, 1626978600000, 1627065000000, 
          1627151400000, 1627237800000, 1627324200000, 1627410600000, 1627497000000, 1627583400000, 
          1627669800000, 1627756200000, 1627842600000, 1627929000000, 1628015400000, 1628101800000, 
          1628188200000, 1628274600000, 1628361000000, 1628447400000, 1628533800000, 1628620200000, 
          1628706600000, 1628793000000, 1628879400000, 1628965800000, 1629052200000, 1629138600000, 
          1629225000000, 1629311400000, 1629397800000, 1629484200000, 1629570600000, 1629657000000, 
          1629743400000, 1629829800000, 1629916200000, 1630002600000, 1630089000000, 1630175400000, 
          1630261800000, 1630348200000, 1630434600000, 1630521000000, 1630607400000, 1630693800000, 
          1630780200000, 1630866600000, 1630953000000, 1631039400000, 1631125800000, 1631212200000, 
          1631298600000, 1631385000000, 1631471400000, 1631557800000, 1631644200000, 1631730600000, 
          1631817000000, 1631903400000, 1631989800000, 1632076200000, 1632162600000, 1632249000000, 
          1632335400000, 1632421800000, 1632508200000, 1632594600000, 1632681000000, 1632767400000, 
          1632853800000, 1632940200000, 1633026600000, 1633113000000, 1633199400000, 1633285800000, 
          1633372200000, 1633458600000, 1633545000000, 1633631400000, 1633717800000, 1633804200000, 
          1633890600000, 1633977000000, 1634063400000, 1634149800000, 1634236200000, 1634322600000, 
          1634409000000, 1634495400000, 1634581800000, 1634668200000, 1634754600000, 1634841000000, 
          1634927400000, 1635013800000, 1635100200000, 1635186600000, 1635273000000, 1635359400000, 
          1635445800000, 1635532200000, 1635618600000, 1635705000000, 1635791400000, 1635877800000, 
          1635964200000, 1636050600000, 1636137000000, 1636223400000, 1636309800000, 1636396200000, 
          1636482600000, 1636569000000, 1636655400000, 1636741800000, 1636828200000, 1636914600000, 
          1637001000000, 1637087400000, 1637173800000, 1637260200000, 1637346600000, 1637433000000, 
          1637519400000, 1637605800000, 1637692200000, 1637778600000, 1637865000000, 1637951400000, 
          1638037800000, 1638124200000, 1638210600000, 1638297000000, 1638383400000, 1638469800000, 
          1638556200000, 1638642600000, 1638729000000, 1638815400000, 1638901800000, 1638988200000, 
          1639074600000, 1639161000000, 1639247400000, 1639333800000, 1639420200000, 1639506600000, 
          1639593000000, 1639679400000, 1639765800000, 1639852200000, 1639938600000, 1640025000000, 
          1640111400000, 1640197800000, 1640284200000, 1640370600000, 1640457000000, 1640543400000, 
          1640629800000, 1640716200000, 1640802600000, 1640889000000, 1640975400000, 1641061800000, 
          1641148200000, 1641234600000, 1641321000000, 1641407400000, 1641493800000, 1641580200000, 
          1641666600000, 1641753000000, 1641839400000, 1641925800000, 1642012200000, 1642098600000, 
          1642185000000, 1642271400000, 1642357800000, 1642444200000, 1642530600000, 1642617000000, 
          1642703400000, 1642789800000, 1642876200000, 1642962600000, 1643049000000, 1643135400000, 
          1643221800000, 1643308200000, 1643394600000, 1643481000000, 1643567400000, 1643653800000, 
          1643740200000, 1643826600000, 1643913000000, 1643999400000, 1644085800000, 1644172200000, 
          1644258600000, 1644345000000, 1644431400000, 1644517800000, 1644604200000, 1644690600000, 
          1644777000000, 1644863400000, 1644949800000, 1645036200000, 1645122600000, 1645209000000, 
          1645295400000, 1645381800000, 1645468200000, 1645554600000, 1645641000000, 1645727400000, 
          1645813800000, 1645900200000, 1645986600000, 1646073000000, 1646159400000, 1646245800000, 
          1646332200000, 1646418600000, 1646505000000, 1646591400000, 1646677800000, 1646764200000, 
          1646850600000, 1646937000000, 1647023400000, 1647109800000, 1647196200000, 1647282600000, 
          1647369000000, 1647455400000, 1647541800000, 1647628200000, 1647714600000, 1647801000000, 
          1647887400000, 1647973800000, 1648060200000, 1648146600000, 1648233000000, 1648319400000, 
          1648405800000, 1648492200000, 1648578600000, 1648665000000, 1648751400000, 1648837800000, 
          1648924200000, 1649010600000, 1649097000000, 1649183400000, 1649269800000, 1649356200000, 
          1649442600000, 1649529000000, 1649615400000, 1649701800000, 1649788200000, 1649874600000, 
          1649961000000, 1650047400000, 1650133800000, 1650220200000, 1650306600000, 1650393000000, 
          1650479400000, 1650565800000, 1650652200000, 1650738600000, 1650825000000, 1650911400000, 
          1650997800000, 1651084200000, 1651170600000, 1651257000000, 1651343400000, 1651429800000, 
          1651516200000, 1651602600000, 1651689000000, 1651775400000, 1651861800000, 1651948200000, 
          1652034600000, 1652121000000, 1652207400000, 1652293800000, 1652380200000, 1652466600000, 
          1652553000000, 1652639400000, 1652725800000, 1652812200000, 1652898600000, 1652985000000, 
          1653071400000, 1653157800000, 1653244200000, 1653330600000, 1653417000000, 1653503400000, 
          1653589800000, 1653676200000, 1653762600000, 1653849000000, 1653935400000, 1654021800000, 
          1654108200000, 1654194600000, 1654281000000, 1654367400000, 1654453800000, 1654540200000, 
          1654626600000, 1654713000000, 1654799400000, 1654885800000, 1654972200000, 1655058600000, 
          1655145000000, 1655231400000, 1655317800000, 1655404200000, 1655490600000, 1655577000000, 
          1655663400000, 1655749800000, 1655836200000, 1655922600000, 1656009000000, 1656095400000, 
          1656181800000, 1656268200000, 1656354600000, 1656441000000, 1656527400000, 1656613800000, 
          1656700200000, 1656786600000, 1656873000000, 1656959400000, 1657045800000, 1657132200000, 
          1657218600000, 1657305000000, 1657391400000, 1657477800000, 1657564200000, 1657650600000, 
          1657737000000, 1657823400000, 1657909800000, 1657996200000, 1658082600000, 1658169000000, 
          1658255400000, 1658341800000, 1658428200000, 1658514600000, 1658601000000, 1658687400000, 
          1658773800000, 1658860200000, 1658946600000, 1659033000000, 1659119400000, 1659205800000, 
          1659292200000, 1659378600000, 1659465000000, 1659551400000, 1659637800000, 1659724200000, 
          1659810600000, 1659897000000, 1659983400000, 1660069800000, 1660156200000, 1660242600000, 
          1660329000000, 1660415400000, 1660501800000, 1660588200000, 1660674600000, 1660761000000, 
          1660847400000, 1660933800000, 1661020200000, 1661106600000, 1661193000000, 1661279400000, 
          1661365800000, 1661452200000, 1661538600000, 1661625000000, 1661711400000, 1661797800000, 
          1661884200000, 1661970600000, 1662057000000, 1662143400000, 1662229800000, 1662316200000, 
          1662402600000, 1662489000000, 1662575400000, 1662661800000, 1662748200000, 1662834600000, 
          1662921000000, 1663007400000, 1663093800000, 1663180200000, 1663266600000, 1663353000000, 
          1663439400000, 1663525800000, 1663612200000, 1663698600000, 1663785000000, 1663871400000, 
          1663957800000, 1664044200000, 1664130600000, 1664217000000, 1664303400000, 1664389800000, 

        ] ;

        var eodData = [
          100, 103, 101, 105, 104, 103, 103, 100, 96, 97, 101, 99, 98, 102, 100, 96, 97, 100, 104, 108, 
          111, 110, 113, 113, 115, 112, 115, 115, 114, 116, 118, 120, 116, 116, 120, 123, 119, 114, 109, 110, 
          109, 109, 105, 102, 102, 105, 102, 104, 107, 107, 107, 107, 106, 110, 113, 110, 108, 107, 107, 103, 
          107, 109, 110, 111, 111, 106, 101, 102, 98, 98, 101, 102, 97, 100, 99, 100, 104, 106, 104, 108, 
          107, 102, 102, 104, 108, 112, 111, 112, 110, 107, 103, 104, 105, 101, 98, 102, 101, 97, 94, 94, 
          90, 85, 81, 80, 78, 80, 76, 77, 80, 83, 83, 82, 83, 86, 90, 94, 95, 93, 94, 95, 
          98, 99, 99, 100, 99, 96, 91, 92, 89, 88, 92, 88, 87, 90, 94, 97, 99, 101, 99, 100, 
          99, 100, 103, 104, 108, 104, 101, 103, 101, 98, 96, 99, 96, 95, 98, 102, 102, 97, 97, 96, 
          91, 88, 86, 87, 85, 88, 83, 86, 85, 81, 76, 75, 79, 80, 82, 78, 81, 77, 81, 82, 
          82, 81, 82, 79, 83, 85, 81, 76, 78, 82, 86, 86, 84, 85, 82, 84, 88, 92, 95, 92, 
          89, 84, 81, 79, 83, 82, 86, 88, 88, 86, 89, 90, 93, 93, 94, 92, 96, 98, 99, 99, 
          97, 95, 95, 94, 97, 92, 91, 93, 97, 96, 97, 93, 92, 93, 90, 86, 90, 90, 92, 92, 
          89, 84, 85, 89, 91, 95, 95, 96, 98, 100, 104, 106, 105, 109, 104, 106, 101, 104, 102, 100, 
          102, 102, 105, 108, 110, 107, 102, 103, 104, 108, 107, 108, 110, 111, 114, 116, 112, 114, 114, 113, 
          115, 110, 105, 107, 111, 109, 108, 109, 112, 107, 107, 109, 104, 108, 108, 111, 112, 113, 109, 105, 
          108, 112, 114, 117, 115, 115, 118, 122, 125, 125, 127, 128, 130, 134, 132, 133, 131, 132, 127, 128, 
          126, 130, 132, 133, 135, 134, 133, 135, 135, 133, 136, 138, 139, 142, 141, 137, 141, 142, 139, 142, 
          141, 143, 144, 140, 141, 142, 143, 145, 142, 140, 135, 139, 139, 136, 132, 131, 131, 127, 128, 123, 
          126, 122, 122, 125, 127, 129, 130, 134, 129, 132, 134, 138, 140, 135, 135, 139, 140, 136, 138, 139, 
          143, 145, 148, 147, 143, 146, 146, 150, 149, 144, 142, 144, 139, 143, 144, 145, 146, 148, 146, 146, 
          144, 147, 142, 144, 145, 148, 147, 145, 147, 144, 143, 146, 143, 138, 138, 142, 145, 149, 147, 142, 
          138, 138, 142, 137, 139, 142, 138, 134, 136, 136, 136, 137, 139, 136, 140, 143, 141, 143, 144, 143, 
          146, 147, 150, 148, 151, 149, 147, 148, 149, 153, 154, 150, 150, 146, 148, 149, 144, 145, 143, 140, 
          140, 139, 136, 136, 131, 134, 129, 124, 125, 126, 128, 128, 132, 134, 134, 132, 132, 131, 134, 131, 
          133, 136, 134, 137, 136, 131, 
        ] ;

        var buyData = [
          {x:1625855400000, y:110, q:1},
          {x:1626201000000, y:102, q:2},
          {x:1626287400000, y:102, q:6},
          {x:1628015400000, y:111, q:8},
          {x:1629657000000, y:104, q:1},
          {x:1631039400000, y:94, q:6},
          {x:1631385000000, y:80, q:8},
          {x:1631903400000, y:83, q:8},
          {x:1635100200000, y:101, q:7},
          {x:1636655400000, y:85, q:2},
          {x:1637346600000, y:79, q:4},
          {x:1637433000000, y:80, q:10},
          {x:1637778600000, y:77, q:5},
          {x:1643135400000, y:92, q:8},
          {x:1644258600000, y:105, q:6},
          {x:1645900200000, y:108, q:4},
          {x:1645986600000, y:110, q:10},
          {x:1651084200000, y:138, q:2},
          {x:1655836200000, y:146, q:10},
          {x:1656786600000, y:148, q:4},
          {x:1658255400000, y:138, q:9},
          {x:1660588200000, y:147, q:4},
          {x:1661193000000, y:149, q:4},
          {x:1663957800000, y:133, q:1},
          {x:1664389800000, y:131, q:5},
        ] ;

        var sellData = [
          {x:1622745000000, y:105, q:0},
          {x:1624041000000, y:104, q:0},
          {x:1624732200000, y:115, q:0},
          {x:1628879400000, y:99, q:9},
          {x:1630261800000, y:103, q:9},
          {x:1630693800000, y:102, q:0},
          {x:1632853800000, y:98, q:7},
          {x:1633717800000, y:92, q:7},
          {x:1633804200000, y:88, q:8},
          {x:1638988200000, y:86, q:7},
          {x:1640025000000, y:79, q:3},
          {x:1643308200000, y:84, q:3},
          {x:1644345000000, y:109, q:9},
          {x:1648924200000, y:118, q:3},
          {x:1649097000000, y:125, q:8},
          {x:1650565800000, y:134, q:7},
          {x:1652380200000, y:143, q:5},
          {x:1658773800000, y:138, q:8},
          {x:1658860200000, y:138, q:9},
          {x:1658946600000, y:142, q:2},
          {x:1659983400000, y:140, q:3},
          {x:1661279400000, y:153, q:9},
          {x:1661884200000, y:144, q:5},
          {x:1663007400000, y:126, q:8},
        ] ;

        var avgData = [
          {x:1622485800000, y:105},
          {x:1664389800000, y:105},
        ] ;

        const data = {
          labels: labels,
          datasets: [
              {
                type             : 'scatter',
                data             : buyData,
                backgroundColor  : BUY_COLOR,
                borderColor      : BUY_COLOR,
                radius           : SCATTER_POINT_RADIUS,
              },
              {
                type             : 'scatter',
                data             : sellData,
                backgroundColor  : SELL_COLOR,
                borderColor      : SELL_COLOR,
                radius           : SCATTER_POINT_RADIUS,
              },
              {
                type             : 'scatter',
                data             : avgData,
                backgroundColor  : AVG_LINE_COLOR,
                borderColor      : AVG_LINE_COLOR,
                radius           : 5,
                borderWidth      : 1,
                showLine         : true,
              },
              {
                type             : 'line',
                data             : eodData,
                borderColor      : EOD_LINE_COLOR,
                backgroundColor  : EOD_LINE_COLOR,
                borderWidth      : 1,
                tension          : 0,
                radius           : 0,
              },
            ]
        } ;
        
        const options = {
            plugins : {
                legend: {
                    display: false,
                },
                tooltip: {
                    callbacks: {
                        title : renderTooltipTitle,
                        label : renderTooltipLabel
                    }
                }
            },
            scales : {
                x : {
                    type:'timeseries',
                    time: { unit: 'day' }
                }  
            }
        } ;
        
        chart = new Chart( ctx, {
            data: data,
            options: options
        } ) ;
    }
    
    function renderTooltipTitle( context ) {
        var title = context[0].label ;
        title = title.substring( 0, title.lastIndexOf( ',' ) ) ;
        return title ;
    }
    
    function renderTooltipLabel( context ) {
        if( context.dataset.type == 'scatter' ) {
            
            if( context.raw.hasOwnProperty( 'q' ) ) {
                return "Units = " + context.dataset.data[ context.dataIndex ].q ;
            }
            return "Avg price = " + context.formattedValue ;
        }
        return "Price = " + context.formattedValue ;
    }
    
    function fetchChartData() {
    }
} ) ;